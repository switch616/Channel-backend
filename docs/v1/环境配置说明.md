# 环境配置说明

## 配置文件结构

项目采用分层配置结构，便于管理不同环境的配置：

```
Channel-backend/
├── .env                    # 公共配置文件（包含 APP_ENV 环境标识）
├── .env.dev                # 开发环境特定配置
├── .env.test               # 测试环境特定配置
├── .env.prod               # 生产环境特定配置
└── .env.*.example          # 配置文件示例（可参考）
```

## 配置加载顺序

1. **读取 `.env` 文件**：获取 `APP_ENV` 环境标识和公共配置
2. **根据 `APP_ENV` 读取对应环境文件**：如 `APP_ENV=test` 则读取 `.env.test`
3. **合并配置**：环境特定配置会覆盖公共配置
4. **系统环境变量**：优先级最高，可覆盖文件配置

## 配置文件说明

### `.env` - 公共配置文件

存放所有环境共享的公共配置，**必须包含 `APP_ENV` 环境标识**。

```env
# 环境标识（必填）
APP_ENV=dev  # 可选值：dev | test | prod

# 公共配置示例
APP_NAME=ChannelDemo
LOG_LEVEL=INFO
```

**注意**：
- `APP_ENV` 用于决定加载哪个环境的配置文件
- 公共配置会被环境特定配置覆盖
- 敏感信息建议放在环境特定配置文件中

### `.env.dev` - 开发环境配置

开发环境的所有配置项，包括数据库、Redis、MongoDB、JWT 等。

```env
# 数据库配置
DB_USER=root
DB_PASSWORD=your_password
DB_HOST=localhost
DB_PORT=3306
DB_NAME=channel_dev

# ... 其他配置
```

### `.env.test` - 测试环境配置

测试环境配置，包含测试模式相关配置。

```env
# 数据库配置
DB_USER=root
DB_PASSWORD=your_password
DB_HOST=localhost
DB_PORT=3306
DB_NAME=channel_test

# 测试模式配置
TEST_MODE_MAX_VIDEOS=10
TEST_MODE_IP_WHITELIST=192.168.1.100,10.0.0.50

# ... 其他配置
```

### `.env.prod` - 生产环境配置

生产环境配置，**请使用强密码和安全的密钥**。

```env
# 数据库配置
DB_USER=your_db_user
DB_PASSWORD=your_strong_password
DB_HOST=your_db_host
DB_PORT=3306
DB_NAME=channel_prod

# ... 其他配置
```

## 使用方法

### 1. 初始化配置文件

```bash
# 复制示例文件
cp .env.example .env
cp .env.dev.example .env.dev
cp .env.test.example .env.test
cp .env.prod.example .env.prod

# 编辑配置文件，填写实际值
vim .env
vim .env.dev
```

### 2. 切换环境

只需修改 `.env` 文件中的 `APP_ENV` 值：

```env
# 切换到测试环境
APP_ENV=test

# 切换到生产环境
APP_ENV=prod

# 切换回开发环境
APP_ENV=dev
```

### 3. 启动应用

```bash
# 直接运行，会自动读取 .env 中的 APP_ENV
python3 main.py

# 或使用启动脚本
./run.sh
```

**注意**：`run.sh` 中不再需要设置 `APP_ENV`，直接从 `.env` 文件读取。

### 4. 使用 Alembic 迁移

Alembic 会自动根据 `.env` 中的 `APP_ENV` 读取对应环境的数据库配置：

```bash
# 数据库迁移
alembic upgrade head

# 或使用脚本
./update_sql.sh
```

## 配置优先级

配置项的优先级从高到低：

1. **系统环境变量**（最高优先级）
2. **环境特定配置文件**（`.env.{env}`）
3. **公共配置文件**（`.env`）
4. **默认值**（代码中定义的默认值）

## 注意事项

1. **不要提交敏感信息**：确保 `.env*` 文件已添加到 `.gitignore`
2. **使用示例文件**：将 `.env.*.example` 文件提交到版本控制，作为配置模板
3. **环境隔离**：不同环境使用不同的数据库，避免数据混乱
4. **密钥安全**：生产环境务必使用强随机密钥
5. **APP_ENV 位置**：`APP_ENV` 必须在 `.env` 文件中，不能只在环境特定文件中

## 故障排查

### 问题：找不到配置文件

**错误信息**：`FileNotFoundError: .env.dev`

**解决**：
- 检查 `.env` 文件是否存在
- 检查 `.env` 中的 `APP_ENV` 值是否正确
- 检查对应的 `.env.{env}` 文件是否存在

### 问题：配置未生效

**原因**：可能是配置优先级问题

**解决**：
- 检查系统环境变量是否覆盖了文件配置
- 确认环境特定配置文件中的值是否正确
- 重启应用使配置生效

### 问题：Alembic 迁移失败

**错误信息**：`ValidationError: Extra inputs are not permitted`

**解决**：
- 确保 `.env` 文件中的 `APP_ENV` 值正确
- 检查配置文件中是否有未定义的字段
- 确认 `APP_ENV` 不会被传递给 Settings 类（已自动处理）

## 相关文件

- 配置类：`app/core/config.py`
- Alembic 配置：`alembic/env.py`
- 启动脚本：`run.sh`
- 迁移脚本：`update_sql.sh`

