# 测试模式使用说明

## 概述

测试模式是专为公网测试环境设计的安全模式，当 `APP_ENV=test` 时自动启用。该模式会限制某些功能，确保测试环境的安全性。

## 启用方式

### 方式1：通过环境变量（推荐）

```bash
export APP_ENV=test
python3 main.py
```

### 方式2：在启动脚本中设置

在 `run.sh` 中已经设置了：
```bash
export APP_ENV=test
```

## 功能限制

### 1. 禁止用户注册

- **限制接口**：`POST /api/v1/user/auth/register`
- **行为**：测试模式下，所有注册请求将被拒绝
- **响应**：返回 403 错误，提示"测试模式：当前不允许注册新用户"

### 2. 视频上传数量限制

- **限制接口**：`POST /api/v1/video/upload_video`
- **限制数量**：每个用户最多上传 **10** 个视频（可在配置中修改）
- **检查时机**：上传前检查用户当前视频数量
- **响应**：如果超过限制，返回错误提示

### 3. 测试模式标识

- **响应头**：所有响应会包含以下标识
  - `X-Test-Mode: true`
  - `X-Environment: test`
- **用途**：前端可以根据这些标识显示测试环境提示

## 安全措施

### IP白名单（可选）

如果需要在测试模式下限制访问IP，可以通过以下方式配置：

#### 方式1：环境变量
```bash
export TEST_MODE_IP_WHITELIST="192.168.1.100,10.0.0.50,203.0.113.1"
```

#### 方式2：配置文件（.env.test）
```env
TEST_MODE_IP_WHITELIST=192.168.1.100,10.0.0.50,203.0.113.1
```

**注意**：
- IP地址用逗号分隔
- 如果未设置白名单，则允许所有IP访问
- 白名单会检查 `X-Forwarded-For`、`X-Real-IP` 和客户端IP

### 其他安全建议

1. **使用HTTPS**：公网测试环境建议使用HTTPS加密传输
2. **访问频率限制**：可以结合现有的反爬虫中间件使用
3. **数据库备份**：测试环境数据可能被频繁修改，建议定期备份
4. **日志监控**：监控异常访问和错误日志
5. **定期清理**：定期清理测试数据和过期文件

## 配置项

在 `.env.test` 或配置类中可以设置以下参数：

```env
# 测试模式下每个用户最大视频上传数量（默认：10）
TEST_MODE_MAX_VIDEOS=10

# IP白名单（可选，逗号分隔）
TEST_MODE_IP_WHITELIST=192.168.1.100,10.0.0.50
```

## 前端适配

前端可以通过检查响应头来判断是否为测试模式：

```javascript
// 检查响应头
const isTestMode = response.headers['x-test-mode'] === 'true';

if (isTestMode) {
  // 显示测试环境提示
  showTestModeBanner();
}
```

## 注意事项

1. **生产环境**：确保生产环境 `APP_ENV` 不为 `test`
2. **数据隔离**：测试环境建议使用独立的数据库
3. **功能验证**：测试模式下的限制可能影响功能测试，需要根据实际情况调整
4. **性能影响**：IP白名单检查会增加少量性能开销，但影响很小

## 故障排查

### 问题：注册接口返回403

**原因**：测试模式已启用，注册功能被禁用

**解决**：
- 检查 `APP_ENV` 环境变量是否为 `test`
- 如需允许注册，将 `APP_ENV` 改为 `dev` 或 `prod`

### 问题：视频上传提示超过限制

**原因**：用户已上传的视频数量达到上限

**解决**：
- 删除部分测试视频
- 或修改 `TEST_MODE_MAX_VIDEOS` 配置增加限制

### 问题：IP被拒绝访问

**原因**：设置了IP白名单，当前IP不在白名单中

**解决**：
- 检查 `TEST_MODE_IP_WHITELIST` 配置
- 将当前IP添加到白名单
- 或清空白名单配置（留空）

## 相关文件

- 中间件：`app/middlewares/test_mode.py`
- 视频上传接口：`app/api/video/upload.py`
- 配置：`app/core/config.py`

